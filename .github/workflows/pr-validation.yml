name: PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for required files
        run: |
          echo "Checking required files..."
          test -f backend/features/ai-icp-assistant/manifest.js || (echo "‚ùå backend/features/ai-icp-assistant/manifest.js is required" && exit 1)
          test -d backend/features/ai-icp-assistant/services || (echo "‚ùå backend/features/ai-icp-assistant/services directory is required" && exit 1)
          test -d backend/features/ai-icp-assistant/routes || (echo "‚ùå backend/features/ai-icp-assistant/routes directory is required" && exit 1)
          test -d backend/features/ai-icp-assistant/repositories || (echo "‚ùå backend/features/ai-icp-assistant/repositories directory is required" && exit 1)
          echo "‚úÖ All required files present"

      - name: Validate backend structure
        run: |
          echo "Validating backend structure..."
          
          # Check for key backend files
          files=(
            "backend/features/ai-icp-assistant/services/AIAssistantService.js"
            "backend/features/ai-icp-assistant/routes/index.js"
            "backend/features/ai-icp-assistant/controllers/AIAssistantController.js"
            "backend/features/ai-icp-assistant/middleware/validation.js"
            "backend/features/ai-icp-assistant/repositories/index.js"
            "backend/features/ai-icp-assistant/repositories/AIConversationRepository.js"
          )
          
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ö†Ô∏è  $file not found (may be optional)"
            fi
          done

      - name: Validate frontend structure
        run: |
          echo "Validating frontend structure..."
          
          if [ -d "frontend/sdk/features/ai-icp-assistant" ]; then
            echo "‚úÖ Frontend SDK directory exists"
            test -f frontend/sdk/features/ai-icp-assistant/index.ts && echo "‚úÖ SDK index.ts exists"
            test -f frontend/sdk/features/ai-icp-assistant/types.ts && echo "‚úÖ SDK types.ts exists"
            test -f frontend/sdk/features/ai-icp-assistant/aiICPAssistantService.ts && echo "‚úÖ SDK service exists"
          else
            echo "‚ö†Ô∏è  No frontend/sdk/features/ai-icp-assistant directory (may be backend-only PR)"
          fi

      - name: Check code syntax
        run: |
          echo "Checking JavaScript syntax..."
          # Check all JS files for syntax errors
          find backend -name "*.js" -type f -exec node --check {} \;
          echo "‚úÖ All JavaScript files have valid syntax"

      - name: Validate migrations
        run: |
          echo "Checking database migrations..."
          if [ -d "migrations" ]; then
            migration_count=$(find migrations -name "*.sql" -type f | wc -l)
            echo "Found $migration_count SQL migration files"
            
            # Validate SQL files have proper naming
            for file in migrations/*.sql; do
              if [ -f "$file" ]; then
                basename=$(basename "$file")
                if [[ $basename =~ ^[0-9]{3}_.+\.sql$ ]]; then
                  echo "‚úÖ $basename follows naming convention"
                else
                  echo "‚ùå $basename does not follow naming convention (###_description.sql)"
                  exit 1
                fi
              fi
            done
          else
            echo "‚ö†Ô∏è  No migrations directory found"
          fi

      - name: Check for secrets
        run: |
          echo "Checking for accidentally committed secrets..."
          
          # Check for common secret patterns
          if grep -r -i "api[_-]key.*=.*['\"][a-zA-Z0-9]{20,}['\"]" backend/ frontend/ 2>/dev/null; then
            echo "‚ùå Possible API keys found in code"
            exit 1
          fi
          
          if grep -r -i "password.*=.*['\"][^'\"]*['\"]" backend/ frontend/ 2>/dev/null | grep -v "password.*process.env"; then
            echo "‚ùå Possible hardcoded passwords found"
            exit 1
          fi
          
          echo "‚úÖ No obvious secrets detected"

      - name: Lint commit messages
        run: |
          echo "Validating commit messages..."
          
          # Get commits in PR
          git log --format=%s origin/main..HEAD | while read commit_msg; do
            echo "Checking: $commit_msg"
            
            # Check if commit follows conventional commits (relaxed)
            if [[ $commit_msg =~ ^(feat|fix|docs|style|refactor|test|chore|ci|perf)(\(.+\))?:\ .+ ]]; then
              echo "‚úÖ Valid commit message"
            else
              echo "‚ö†Ô∏è  Commit message doesn't follow conventional commits format"
              echo "   Expected: <type>(<scope>): <description>"
              echo "   Examples: feat: add new feature, fix(auth): resolve login issue"
            fi
          done

      - name: Test server startup
        run: |
          echo "Testing if server can start..."
          
          # Create a minimal .env file for testing
          echo "GEMINI_API_KEY=test-key-for-validation" > .env
          
          # Try to start server in background and check if it initializes
          timeout 10 node test-server.js &
          SERVER_PID=$!
          
          sleep 5
          
          # Check if server is still running
          if ps -p $SERVER_PID > /dev/null; then
            echo "‚úÖ Server started successfully"
            kill $SERVER_PID 2>/dev/null || true
          else
            echo "‚ùå Server failed to start"
            exit 1
          fi

      - name: Generate PR summary
        if: always()
        run: |
          echo "## üìä PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Changed" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git diff --name-status origin/main..HEAD >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits**: $(git log --oneline origin/main..HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Files changed**: $(git diff --name-only origin/main..HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Insertions**: $(git diff --shortstat origin/main..HEAD | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+')" >> $GITHUB_STEP_SUMMARY
          echo "- **Deletions**: $(git diff --shortstat origin/main..HEAD | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+')" >> $GITHUB_STEP_SUMMARY

  label-pr:
    name: Auto-label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Label based on changes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = new Set();
            
            for (const file of files) {
              if (file.filename.startsWith('backend/')) {
                labels.add('backend');
              }
              if (file.filename.startsWith('frontend/')) {
                labels.add('frontend');
              }
              if (file.filename.startsWith('migrations/')) {
                labels.add('database');
              }
              if (file.filename.includes('test')) {
                labels.add('testing');
              }
              if (file.filename.endsWith('.md')) {
                labels.add('documentation');
              }
            }

            // Add size labels
            const additions = files.reduce((sum, file) => sum + file.additions, 0);
            if (additions < 10) labels.add('size/XS');
            else if (additions < 50) labels.add('size/S');
            else if (additions < 200) labels.add('size/M');
            else if (additions < 500) labels.add('size/L');
            else labels.add('size/XL');

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels),
              });
            }

  security-check:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || echo "‚ö†Ô∏è  Security vulnerabilities found, please review"
        continue-on-error: true

      - name: Check for vulnerable dependencies
        run: |
          echo "Checking for known vulnerable packages..."
          npm audit --json > audit-result.json || true
          
          if [ -f audit-result.json ]; then
            high_vulns=$(jq '.metadata.vulnerabilities.high // 0' audit-result.json)
            critical_vulns=$(jq '.metadata.vulnerabilities.critical // 0' audit-result.json)
            
            echo "High vulnerabilities: $high_vulns"
            echo "Critical vulnerabilities: $critical_vulns"
            
            if [ "$critical_vulns" -gt 0 ]; then
              echo "‚ùå Critical vulnerabilities found!"
              exit 1
            fi
          fi
