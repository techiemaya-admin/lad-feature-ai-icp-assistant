name: Sync to LAD Main Repositories

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-backend:
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout feature repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git credentials
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Verify LAD_REPO_TOKEN
        run: |
          if [ -z "${{ secrets.LAD_REPO_TOKEN }}" ]; then
            echo "‚ùå LAD_REPO_TOKEN secret is not set!"
            exit 1
          fi
          echo "‚úÖ LAD_REPO_TOKEN is configured"

      - name: Checkout LAD-Backend
        env:
          GH_TOKEN: ${{ secrets.LAD_REPO_TOKEN }}
        run: |
          echo "üì• Cloning LAD-Backend repository..."
          git clone --depth=1 --branch=develop "https://oauth2:${GH_TOKEN}@github.com/techiemaya-admin/LAD-Backend.git" lad-backend
          cd lad-backend
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          echo "‚úÖ LAD-Backend cloned successfully"

      - name: Copy backend files
        run: |
          echo "üì¶ Starting backend file sync..."
          
          # Verify source exists
          if [ ! -d "backend/features/ai-icp-assistant" ]; then
            echo "‚ùå Source directory not found: backend/features/ai-icp-assistant"
            exit 1
          fi
          
          # Ensure destination exists
          mkdir -p lad-backend/features/ai-icp-assistant
          
          # Sync files WITHOUT delete (safer - only adds/updates)
          if ! rsync -av \
            --exclude='.env*' \
            --exclude='*.local.js' \
            --exclude='node_modules/' \
            --exclude='.DS_Store' \
            backend/features/ai-icp-assistant/ lad-backend/features/ai-icp-assistant/; then
            echo "‚ùå rsync failed!"
            exit 1
          fi
          
          echo "‚úÖ Files synced successfully"

      - name: Verify critical files
        run: |
          echo "üîç Verifying critical files..."
          MISSING=0
          
          # Check for essential files
          CRITICAL_FILES=(
            "lad-backend/features/ai-icp-assistant/manifest.js"
            "lad-backend/features/ai-icp-assistant/routes/index.js"
            "lad-backend/features/ai-icp-assistant/controllers/AIAssistantController.js"
            "lad-backend/features/ai-icp-assistant/repositories/index.js"
          )
          
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå CRITICAL: $file is missing!"
              MISSING=1
            else
              echo "‚úÖ $file exists"
            fi
          done
          
          if [ $MISSING -eq 1 ]; then
            echo "‚ùå Sync validation failed - critical files missing"
            exit 1
          fi
          
          echo "‚úÖ All critical files verified"

      - name: Commit and push to LAD-Backend
        working-directory: lad-backend
        run: |
          # Pull latest changes to avoid conflicts
          echo "üì• Pulling latest changes..."
          git pull origin develop --rebase || {
            echo "‚ö†Ô∏è Rebase conflict detected"
            git rebase --abort
            exit 1
          }
          
          # Stage changes
          git add features/ai-icp-assistant/
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
            exit 0
          fi
          
          # Show what changed
          echo "üìù Changes to be committed:"
          git diff --staged --stat
          
          # Commit
          git commit -m "feat(ai-icp-assistant): auto-sync from feature repo" \
            -m "Synced from: ${{ github.repository }}@${{ github.sha }}" \
            -m "Triggered by: ${{ github.actor }}" \
            -m "Timestamp: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" \
            -m "Workflow: ${{ github.workflow }}"
          
          # Push with retry logic
          echo "üì§ Pushing to LAD-Backend..."
          for attempt in {1..3}; do
            if git push origin develop; then
              echo "‚úÖ Push successful on attempt $attempt"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Push failed, retrying ($attempt/3)..."
            sleep 2
            git pull origin develop --rebase || {
              echo "‚ùå Rebase failed on retry"
              git rebase --abort
              exit 1
            }
          done
          
          echo "‚ùå Failed to push after 3 attempts"
          exit 1

  sync-frontend:
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout feature repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git credentials
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Verify LAD_REPO_TOKEN
        run: |
          if [ -z "${{ secrets.LAD_REPO_TOKEN }}" ]; then
            echo "‚ùå LAD_REPO_TOKEN secret is not set!"
            exit 1
          fi
          echo "‚úÖ LAD_REPO_TOKEN is configured"

      - name: Checkout LAD-Frontend
        env:
          GH_TOKEN: ${{ secrets.LAD_REPO_TOKEN }}
        run: |
          echo "üì• Cloning LAD-Frontend repository..."
          git clone --depth=1 --branch=develop "https://oauth2:${GH_TOKEN}@github.com/techiemaya-admin/LAD-Frontend.git" lad-frontend
          cd lad-frontend
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          echo "‚úÖ LAD-Frontend cloned successfully"

      - name: Verify LAD_REPO_TOKEN
        run: |
          echo "üì¶ Starting frontend SDK sync..."
          
          # Check if SDK directory exists
          if [ ! -d "frontend/sdk/features/ai-icp-assistant" ]; then
            echo "‚ö†Ô∏è No frontend SDK directory found, skipping"
            echo "HAS_SDK=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "HAS_SDK=true" >> $GITHUB_ENV
          
          # Ensure directory exists
          mkdir -p lad-frontend/sdk/features/ai-icp-assistant

          # Sync SDK files WITHOUT delete
          if ! rsync -av \
            --exclude='node_modules/' \
            --exclude='.DS_Store' \
            --exclude='*.test.ts' \
            --exclude='*.test.tsx' \
            frontend/sdk/features/ai-icp-assistant/ lad-frontend/sdk/features/ai-icp-assistant/; then
            echo "‚ùå SDK sync failed!"
            exit 1
          fi

          # Copy components if they exist
          if [ -d "frontend/components" ] && [ "$(ls -A frontend/components 2>/dev/null)" ]; then
            echo "üì¶ Syncing components..."
            mkdir -p lad-frontend/web/src/features/ai-icp-assistant
            rsync -av \
              --exclude='node_modules/' \
              --exclude='.DS_Store' \
              frontend/components/ lad-frontend/web/src/features/ai-icp-assistant/
            echo "HAS_COMPONENTS=true" >> $GITHUB_ENV
          else
            echo "‚ÑπÔ∏è No components to sync"
            echo "HAS_COMPONENTS=false" >> $GITHUB_ENV
          fi
          
          echo "‚úÖ Frontend files synced successfully"

      - name: Verify frontend files
        if: env.HAS_SDK == 'true'
        run: |
          echo "üîç Verifying frontend SDK files..."
          
          # Check for essential SDK files
          CRITICAL_FILES=(
            "lad-frontend/sdk/features/ai-icp-assistant/index.ts"
            "lad-frontend/sdk/features/ai-icp-assistant/aiICPAssistantService.ts"
            "lad-frontend/sdk/features/ai-icp-assistant/types.ts"
          )
          
          MISSING=0
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå CRITICAL: $file is missing!"
              MISSING=1
            else
              echo "‚úÖ $file exists"
            fi
          done
          
          if [ $MISSING -eq 1 ]; then
            echo "‚ùå Frontend sync validation failed"
            exit 1
          fi
          
          echo "‚úÖ Frontend SDK verified"

      - name: Commit and push to LAD-Frontend
        if: env.HAS_SDK == 'true'
        working-directory: lad-frontend
        run: |
          # Pull latest
          echo "üì• Pulling latest changes..."
          git pull origin develop --rebase || {
            echo "‚ö†Ô∏è Rebase conflict detected"
            git rebase --abort
            exit 1
          }
          
          # Stage all changes
          git add sdk/features/ai-icp-assistant/
          if [ "${{ env.HAS_COMPONENTS }}" = "true" ]; then
            git add web/src/features/ai-icp-assistant/
          fi
          
          # Check for changes
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
            exit 0
          fi
          
          # Show changes
          echo "üìù Changes to be committed:"
          git diff --staged --stat
          
          # Commit
          git commit -m "feat(ai-icp-assistant): auto-sync SDK from feature repo" \
            -m "Synced from: ${{ github.repository }}@${{ github.sha }}" \
            -m "Triggered by: ${{ github.actor }}" \
            -m "Timestamp: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" \
            -m "Workflow: ${{ github.workflow }}"
          
          # Push with retry
          echo "üì§ Pushing to LAD-Frontend..."
          for attempt in {1..3}; do
            if git push origin develop; then
              echo "‚úÖ Push successful on attempt $attempt"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Push failed, retrying ($attempt/3)..."
            sleep 2
            git pull origin develop --rebase || {
              echo "‚ùå Rebase failed on retry"
              git rebase --abort
              exit 1
            }
          done
          
          echo "‚ùå Failed to push after 3 attempts"
          exit 1

  notify-success:
    needs: [sync-backend, sync-frontend]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Success notification
        run: |
          echo "‚úÖ Successfully synced ai-icp-assistant feature to LAD repositories"
          echo "Backend: ‚úÖ"
          echo "Frontend: ‚úÖ"

  notify-failure:
    needs: [sync-backend, sync-frontend]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Failure notification
        run: |
          echo "‚ùå Sync to LAD repositories failed"
          echo "Check workflow logs for details"
          exit 1
