name: Sync to LAD Main Repositories

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout feature repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Checkout LAD-Backend
        uses: actions/checkout@v3
        with:
          repository: techiemaya-admin/LAD-Backend
          token: ${{ secrets.LAD_REPO_TOKEN }}
          path: lad-backend
          ref: develop

      - name: Copy backend files
        run: |
          # Remove old files
          rm -rf lad-backend/features/ai-icp-assistant/*

          # Ensure directories exist
          mkdir -p lad-backend/features/ai-icp-assistant/services
          mkdir -p lad-backend/features/ai-icp-assistant/routes
          mkdir -p lad-backend/features/ai-icp-assistant/controllers
          mkdir -p lad-backend/features/ai-icp-assistant/middleware
          mkdir -p lad-backend/features/ai-icp-assistant/models

          # Copy new files
          cp backend/services/* lad-backend/features/ai-icp-assistant/services/
          cp backend/routes/index.js lad-backend/features/ai-icp-assistant/routes/index.js
          cp backend/controllers/* lad-backend/features/ai-icp-assistant/controllers/ 2>/dev/null || mkdir -p lad-backend/features/ai-icp-assistant/controllers && cp backend/controllers/* lad-backend/features/ai-icp-assistant/controllers/
          cp backend/middleware/* lad-backend/features/ai-icp-assistant/middleware/ 2>/dev/null || mkdir -p lad-backend/features/ai-icp-assistant/middleware && cp backend/middleware/* lad-backend/features/ai-icp-assistant/middleware/
          cp backend/models/* lad-backend/features/ai-icp-assistant/models/ 2>/dev/null || mkdir -p lad-backend/features/ai-icp-assistant/models && cp backend/models/* lad-backend/features/ai-icp-assistant/models/
          cp backend/manifest.js lad-backend/features/ai-icp-assistant/
          [ -f backend/UPGRADE_NOTES.md ] && cp backend/UPGRADE_NOTES.md lad-backend/features/ai-icp-assistant/ || echo "No UPGRADE_NOTES.md"
          [ -f backend/README.md ] && cp backend/README.md lad-backend/features/ai-icp-assistant/ || echo "No README.md"

      - name: Commit and push to LAD-Backend
        working-directory: lad-backend
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add features/ai-icp-assistant/
          git commit -m "feat(ai-icp-assistant): auto-sync from feature repo

          Synced from: ${{ github.sha }}
          Repository: lad-feature-ai-icp-assistant
          Timestamp: $(date -u)
          " || echo "No changes to commit"
          git push origin develop

  sync-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout feature repo
        uses: actions/checkout@v3

      - name: Checkout LAD-Frontend
        uses: actions/checkout@v3
        with:
          repository: techiemaya-admin/LAD-Frontend
          token: ${{ secrets.LAD_REPO_TOKEN }}
          path: lad-frontend
          ref: develop

      - name: Copy frontend SDK files
        run: |
          # Remove old SDK
          rm -rf lad-frontend/sdk/features/ai-icp-assistant/*

          # Ensure directory exists
          mkdir -p lad-frontend/sdk/features/ai-icp-assistant

          # Copy new SDK
          cp -r frontend/sdk/* lad-frontend/sdk/features/ai-icp-assistant/

          # Copy components if exist
          if [ -d "frontend/components" ] && [ "$(ls -A frontend/components)" ]; then
            mkdir -p lad-frontend/web/src/features/ai-icp-assistant
            rm -rf lad-frontend/web/src/features/ai-icp-assistant/*
            cp -r frontend/components/* lad-frontend/web/src/features/ai-icp-assistant/
          fi

      - name: Commit and push to LAD-Frontend
        working-directory: lad-frontend
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add sdk/features/ai-icp-assistant/
          if [ -d "web/src/features/ai-icp-assistant" ]; then
            git add web/src/features/ai-icp-assistant/
          fi
          git commit -m "feat(ai-icp-assistant): auto-sync SDK from feature repo

          Synced from: ${{ github.sha }}
          Repository: lad-feature-ai-icp-assistant
          Timestamp: $(date -u)
          " || echo "No changes to commit"
          git push origin develop
